import*as o from"https://cdn.jsdelivr.net/npm/three@0.118/build/three.module.js";import{FBXLoader as w}from"https://cdn.jsdelivr.net/npm/three@0.118.1/examples/jsm/loaders/FBXLoader.js";import"https://cdn.jsdelivr.net/npm/three@0.118.1/examples/jsm/loaders/GLTFLoader.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();class S{constructor(t){this._animations=t}get animations(){return this._animations}}class k{constructor(t){this._isLoaded=!1,this._Init(t)}_Init(t){this._params=t,this._decceleration=new o.Vector3(-5e-4,-1e-4,-5),this._acceleration=new o.Vector3(1,.25,50),this._velocity=new o.Vector3(0,0,0),this._position=new o.Vector3,this._animations={},this._input=new b,this._stateMachine=new L(new S(this._animations)),this._LoadModels()}_LoadModels(t){if(this._isLoaded){console.warn("Model already loaded, skipping duplicate load."),t&&t(this._target);return}const e=new w;e.setPath("./resources/knight/"),e.load("knight.fbx",s=>{s.scale.setScalar(.1),s.traverse(n=>{n.castShadow=!0}),this._target=s,this._params.scene.add(this._target),this._mixer=new o.AnimationMixer(this._target),this._manager=new o.LoadingManager,this._manager.onLoad=()=>{this._stateMachine.SetState("idle")};const i=(n,l)=>{const c=l.animations[0],f=this._mixer.clipAction(c);this._animations[n]={clip:c,action:f}},a=new w(this._manager);a.setPath("./resources/knight/"),a.load("walk_3.fbx",n=>{i("walk",n)}),a.load("run.fbx",n=>{i("run",n)}),a.load("idle.fbx",n=>{i("idle",n)}),a.load("basic_attack_1.fbx",n=>{i("attack",n)}),this._isLoaded=!0,t&&t(this._target)})}get Position(){return this._position}get Rotation(){return this._target?this._target.quaternion:new o.Quaternion}Update(t){if(!this._stateMachine._currentState)return;this._stateMachine.Update(t,this._input);const e=this._velocity,s=new o.Vector3(e.x*this._decceleration.x,e.y*this._decceleration.y,e.z*this._decceleration.z);s.multiplyScalar(t),s.z=Math.sign(s.z)*Math.min(Math.abs(s.z),Math.abs(e.z)),e.add(s);const i=this._target,a=new o.Quaternion,n=new o.Vector3,l=i.quaternion.clone(),c=this._acceleration.clone();this._input._keys.shift&&c.multiplyScalar(2),this._stateMachine._currentState.Name=="attack"&&c.multiplyScalar(0),this._input._keys.forward&&(e.z+=c.z*t),this._input._keys.backward&&(e.z-=c.z*t),this._input._keys.left&&(n.set(0,1,0),a.setFromAxisAngle(n,4*Math.PI*t*this._acceleration.y),l.multiply(a)),this._input._keys.right&&(n.set(0,1,0),a.setFromAxisAngle(n,4*-Math.PI*t*this._acceleration.y),l.multiply(a)),i.quaternion.copy(l),new o.Vector3().copy(i.position);const _=new o.Vector3(0,0,1);_.applyQuaternion(i.quaternion),_.normalize();const p=new o.Vector3(1,0,0);p.applyQuaternion(i.quaternion),p.normalize(),p.multiplyScalar(e.x*t),_.multiplyScalar(e.z*t),i.position.add(_),i.position.add(p),this._position.copy(i.position),this._mixer&&this._mixer.update(t),d.readyState===WebSocket.OPEN&&d.send(JSON.stringify({type:"updatePosition",id:this._params.id,position:{x:this._position.x,y:this._position.y,z:this._position.z},rotation:{x:i.quaternion.x,y:i.quaternion.y,z:i.quaternion.z,w:i.quaternion.w},animationState:this._stateMachine._currentState.Name}))}}class b{constructor(){this._Init()}_Init(){this._keys={forward:!1,backward:!1,left:!1,right:!1,space:!1,shift:!1},document.addEventListener("keydown",t=>this._onKeyDown(t),!1),document.addEventListener("keyup",t=>this._onKeyUp(t),!1)}_onKeyDown(t){switch(t.keyCode){case 87:this._keys.forward=!0;break;case 65:this._keys.left=!0;break;case 83:this._keys.backward=!0;break;case 68:this._keys.right=!0;break;case 32:this._keys.space=!0;break;case 16:this._keys.shift=!0;break}}_onKeyUp(t){switch(t.keyCode){case 87:this._keys.forward=!1;break;case 65:this._keys.left=!1;break;case 83:this._keys.backward=!1;break;case 68:this._keys.right=!1;break;case 32:this._keys.space=!1;break;case 16:this._keys.shift=!1;break}}}class F{constructor(){this._states={},this._currentState=null}_AddState(t,e){this._states[t]=e}SetState(t){const e=this._currentState;if(e){if(e.Name==t)return;e.Exit()}const s=new this._states[t](this);this._currentState=s,s.Enter(e)}Update(t,e){this._currentState&&this._currentState.Update(t,e)}}class L extends F{constructor(t){super(),this._proxy=t,this._Init()}_Init(){this._AddState("idle",P),this._AddState("walk",E),this._AddState("run",A),this._AddState("attack",M)}}class u{constructor(t){this._parent=t}Enter(){}Exit(){}Update(){}}class M extends u{constructor(t){super(t),this._FinishedCallback=()=>{this._Finished()}}get Name(){return"attack"}Enter(t){const e=this._parent._proxy._animations.attack.action;if(e.getMixer().addEventListener("finished",this._FinishedCallback),t){const i=this._parent._proxy._animations[t.Name].action;e.reset(),e.setLoop(o.LoopOnce,1),e.clampWhenFinished=!0,e.crossFadeFrom(i,.2,!0),e.play()}else e.play()}_Finished(){this._Cleanup(),this._parent.SetState("idle")}_Cleanup(){this._parent._proxy._animations.attack.action.getMixer().removeEventListener("finished",this._CleanupCallback)}Exit(){this._Cleanup()}Update(t){}}class E extends u{constructor(t){super(t)}get Name(){return"walk"}Enter(t){const e=this._parent._proxy._animations.walk.action;if(t){const s=this._parent._proxy._animations[t.Name].action;if(e.enabled=!0,t.Name=="run"){const i=e.getClip().duration/s.getClip().duration;e.time=s.time*i}else e.time=0,e.setEffectiveTimeScale(1),e.setEffectiveWeight(1);e.crossFadeFrom(s,.5,!0),e.play()}else e.play()}Exit(){}Update(t,e){if(e._keys.forward||e._keys.backward){e._keys.shift&&this._parent.SetState("run");return}this._parent.SetState("idle")}}class A extends u{constructor(t){super(t)}get Name(){return"run"}Enter(t){const e=this._parent._proxy._animations.run.action;if(t){const s=this._parent._proxy._animations[t.Name].action;if(e.enabled=!0,t.Name=="walk"){const i=e.getClip().duration/s.getClip().duration;e.time=s.time*i}else e.time=0,e.setEffectiveTimeScale(1),e.setEffectiveWeight(1);e.crossFadeFrom(s,.5,!0),e.play()}else e.play()}Exit(){}Update(t,e){if(e._keys.forward||e._keys.backward){e._keys.shift||this._parent.SetState("walk");return}this._parent.SetState("idle")}}class P extends u{constructor(t){super(t)}get Name(){return"idle"}Enter(t){const e=this._parent._proxy._animations.idle.action;if(t){const s=this._parent._proxy._animations[t.Name].action;e.time=0,e.enabled=!0,e.setEffectiveTimeScale(1),e.setEffectiveWeight(1),e.crossFadeFrom(s,.5,!0),e.play()}else e.play()}Exit(){}Update(t,e){e._keys.forward||e._keys.backward?this._parent.SetState("walk"):e._keys.space&&this._parent.SetState("attack")}}class v{constructor(t){this._params=t,this._camera=t.camera,this._currentPosition=new o.Vector3,this._currentLookat=new o.Vector3}_CalculateIdealOffset(){const t=new o.Vector3(-15,20,-30);return t.applyQuaternion(this._params.target.Rotation),t.add(this._params.target.Position),t}_CalculateIdealLookat(){const t=new o.Vector3(0,10,50);return t.applyQuaternion(this._params.target.Rotation),t.add(this._params.target.Position),t}Update(t){const e=this._CalculateIdealOffset(),s=this._CalculateIdealLookat(),i=1-Math.pow(.001,t);this._currentPosition.lerp(e,i),this._currentLookat.lerp(s,i),this._camera.position.copy(this._currentPosition),this._camera.lookAt(this._currentLookat)}}class C{constructor(){this._Initialize()}_Initialize(){this._threejs=new o.WebGLRenderer({antialias:!0}),this._threejs.outputEncoding=o.sRGBEncoding,this._threejs.shadowMap.enabled=!0,this._threejs.shadowMap.type=o.PCFSoftShadowMap,this._threejs.setPixelRatio(window.devicePixelRatio),this._threejs.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(this._threejs.domElement),window.addEventListener("resize",()=>{this._OnWindowResize()},!1);const t=60,e=1920/1080,s=1,i=1e3;this._camera=new o.PerspectiveCamera(t,e,s,i),this._camera.position.set(25,10,25),this._scene=new o.Scene;let a=new o.DirectionalLight(16777215,1);a.position.set(-100,100,100),a.target.position.set(0,0,0),a.castShadow=!0,a.shadow.bias=-.001,a.shadow.mapSize.width=4096,a.shadow.mapSize.height=4096,a.shadow.camera.near=.1,a.shadow.camera.far=500,a.shadow.camera.near=.5,a.shadow.camera.far=500,a.shadow.camera.left=50,a.shadow.camera.right=-50,a.shadow.camera.top=50,a.shadow.camera.bottom=-50,this._scene.add(a),a=new o.AmbientLight(16777215,.25),this._scene.add(a);const l=new o.CubeTextureLoader().load(["./resources/posx.jpg","./resources/negx.jpg","./resources/posy.jpg","./resources/negy.jpg","./resources/posz.jpg","./resources/negz.jpg"]);l.encoding=o.sRGBEncoding,this._scene.background=l;const c=new o.Mesh(new o.PlaneGeometry(100,100,10,10),new o.MeshStandardMaterial({color:8421504}));c.castShadow=!1,c.receiveShadow=!0,c.rotation.x=-Math.PI/2,this._scene.add(c),this._mixers=[],this._previousRAF=null,this._LoadAnimatedModel(),this._RAF()}_LoadAnimatedModel(){const t={camera:this._camera,scene:this._scene};this._controls=new k(t),this._thirdPersonCamera=new v({camera:this._camera,target:this._controls})}_OnWindowResize(){this._camera.aspect=window.innerWidth/window.innerHeight,this._camera.updateProjectionMatrix(),this._threejs.setSize(window.innerWidth,window.innerHeight)}_RAF(){requestAnimationFrame(t=>{this._previousRAF===null&&(this._previousRAF=t),this._RAF(),this._threejs.render(this._scene,this._camera),this._Step(t-this._previousRAF),this._previousRAF=t})}_Step(t){const e=t*.001;this._mixers&&this._mixers.map(s=>s.update(e)),this._controls&&this._controls.Update(e);for(const s in h){const i=h[s];i._mixer&&i._mixer.update(e)}this._thirdPersonCamera.Update(e)}}let x=null;window.addEventListener("DOMContentLoaded",()=>{x=new C});function y(r,t){const e=new o.Vector3(0,0,0),s=new o.Vector3(100,0,0),i=e.clone();for(let a=0;a<r;a++)i.lerp(s,t);return i}function m(r,t){const e=y(100,r),s=y(50,t);console.log(e.x+" | "+s.x)}m(.01,.01);m(1/100,1/50);m(1-Math.pow(.3,1/100),1-Math.pow(.3,1/50));const h={},d=new WebSocket("ws://localhost:8080");let g=null;d.addEventListener("message",async r=>{let t;if(r.data instanceof Blob){const e=await r.data.text();t=JSON.parse(e)}else t=JSON.parse(r.data);if(t.type==="assignId")g=t.id,console.log(`Assigned player ID: ${g}`);else if(t.type==="updatePosition")if(h[t.id]){const e=h[t.id];e._target?(e._target.position.set(t.position.x,t.position.y,t.position.z),e._target.quaternion.set(t.rotation.x,t.rotation.y,t.rotation.z,t.rotation.w),t.animationState&&e._stateMachine&&e._stateMachine.SetState(t.animationState)):console.warn(`Player model not yet loaded for ID: ${t.id}`)}else{const e={camera:null,scene:x._scene},s=new k(e);s._LoadModels(i=>{i.position.set(t.position.x,t.position.y,t.position.z),i.quaternion.set(t.rotation.x,t.rotation.y,t.rotation.z,t.rotation.w),console.log(`Model loaded and position/rotation set for player: ${t.id}`)}),h[t.id]=s,console.log(`Added new player: ${t.id}`,h)}});d.addEventListener("open",()=>{console.log("Connected to WebSocket server")});d.addEventListener("close",()=>{console.log("Disconnected from WebSocket server")});d.addEventListener("error",r=>{console.error("WebSocket error:",r)});
